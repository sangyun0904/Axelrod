<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
        div.box {
          width: 100%;
          height: 500px;
          margin-bottom: 5px
        }
        div.left {
          width: 49.9%;
          float: left;
          box-sizing: border-box;
          padding: 10px;
          border: 3px solid #003458;
        }
        div.right {
          width: 49.9%;
          float: right;
          box-sizing: border-box;
          padding: 10px;
          border: 3px solid #003458;
        }
        a {
          margin-right: 10px;
        }
        .pagination {
            display: inline-block;
        }

        .pagination a {
            color: black;
            float: left;
            padding: 5px 5px;
            text-decoration: none;
        }

        .pagination a.active {
            background-color: gray;
            color: white;
            border-radius: 2px;
        }

        footer {
          text-align: center;
          padding: 3px;
          background-color: darkslategrey;
          color: white;
        }

        main {
          display: flex;
          flex-direction: column;
        }

        span.red {
             color: red;
        }

        span.blue {
             color: blue;
        }
    </style>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<body  onload="fetchStockSearch(1);">
<section>
<h1>Axelrod Stock Simulator</h1>
    <main>
<div>
    <div class="box left">
        <div class="left" style="border:0px">
            <table>
                <thead>
                <tr>
                    <th> Ticker </th>
                    <th> Price </th>
                </tr>
                </thead>
                <tbody id="stockTableBody">
                <tr th:if="${stocks.empty}">
                    <td colspan="2"> No Stocks Available </td>
                </tr>
                <tr th:each="stock, iStat : ${stocks}">
                    <td><a th:href="@{/homepage/stock(ticker=${stock.ticker}, userId=${userId})}"><span th:text="${stock.ticker}"> </span></a></td>
                    <td><span th:text="${stock.price}"> </span></td>
                </tr>
                </tbody>
            </table>
            <br>
            <div class="pagination" id="stockPagination">
            </div>
            <br>
            <a href="/homepage/create">Create Stock</a>
            <div hidden>
                <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
            </div>
        </div>
        <div class="right" style="height:100%; border:0px;">
            <br>
            <br>
            <p>search : <input id="stockKeyword" type="text" name="stockSearch" oninput="fetchStockSearch(1)"/></p>
        </div>
    </div>
    <div class="box right">
        <div class="left" style="height:100%; border:0px;">
            <table>
                <thead>
                <tr>
                    <th> Username </th>
                    <th> email </th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${players.empty}">
                    <td colspan="2"> No Stocks Available </td>
                </tr>
                <tr th:each="player : ${players}">
                    <td><span th:text="${player.username}"> </span></td>
                    <td><span th:text="${player.email}"> </span></td>
                </tr>
                </tbody>
            </table>
            <a href="/homepage/player/create">Create Player</a>
        </div>
        <div class="right" style="height:100%; border:0px;">
            <table>
                <thead>
                <tr>
                    <th> Title </th>
                    <th> Content </th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="news : ${newslist}">
                    <td><a th:href="${news.url}" th:text="${news.title}"></a></td>
                    <td><span th:text="${news.content}"></span> </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div>
    <div th:if="${userId == null}" class="box left">
        <h3>Login</h3>
        <form action="#" th:action="@{/homepage/login}" th:object="${user}" method="post">
            <p>Username: <input type="text" th:field="*{username}" /></p>
            <p>Password: <input type="text" th:field="*{password}" /></p>
            <p><input type="submit" value="Submit" /> <input type="reset" value="Reset" /></p>
        </form>
    </div>
    <div th:if="${userId != null}" class="box left">
        <div class="left" style="border:0px">
            <h3 th:text="'Hello ' + ${userId} + '!'"></h3>
            <p><a th:href="'/homepage/buy?userId=' + ${userId}">Buy Stock</a><a th:href="'/homepage/sell?userId=' + ${userId}">Sell Stock</a></p>
            <table>
                <thead>
                    <tr><th style="text-align: left">Account Number</th><th style="text-align: left">Balance</th></tr>
                </thead>
                <tbody>
                    <tr th:each="account: ${accounts}">
                        <td><span th:text="${account.accountNum}"></span></td><td><span th:text="${account.balance}"></span></td>
                        <td><a th:href="'/homepage/deposit?userId=' + ${userId} + '&accountNum=' + ${account.accountNum}">Add balance</a></td>
                        <td><a th:href="'/homepage/withdrawal?userId=' + ${userId} + '&accountNum=' + ${account.accountNum}">Withdraw balance</a></td>
                    </tr>
                </tbody>
            </table>
            <p><a th:href="'/homepage/create/account?userId=' + ${userId}">Create Account</a><a href="/homepage/logout">Log Out</a></p>
        </div>
        <div class="right" style="height:100%; border:0px;">
            <table style="margin:auto; width:100%">
                <caption><b>User Portfolio</b></caption>
                <thead>
                <tr>
                    <th> StockId </th>
                    <th> Quantity </th>
                    <th> Current Price </th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${portfolios.empty}">
                    <td colspan="4" style="text-align:center;"> No Portfolios </td>
                </tr>
                <tr th:each="pf : ${portfolios}">
                    <td><span th:text="${pf.ticker}"> </span></td>
                    <td><span th:text="${pf.quantity}"> </span></td>
                    <td>
                        <span th:text="${pf.stockCurrentPrice} + '  ( ' + ${pf.myAvgPrice}"></span>
                        <span th:if="${pf.stockCurrentPrice} > ${pf.myAvgPrice}" th:class="red" th:text="' +' + ${pf.differencePercent}"></span>
                        <span th:if="${pf.stockCurrentPrice} < ${pf.myAvgPrice}" th:class="blue" th:text="' -' + ${pf.differencePercent}"></span>
                        <span th:if="${pf.stockCurrentPrice} == ${pf.myAvgPrice}" th:text="' 0.0%'"> </span>
                        <span> )</span>
                    </td>
                </tr>
                </tbody>
            </table>
            <br>
            <div th:if="${portfolios.totalPages > 0}" class="pagination"
                 th:each="pageNumber : ${portfolioPageNumbers}">
                <a th:if="${userId == null}" th:href="@{/homepage(pfPage=${pageNumber}, stockPage=${stockCurrentPage})}"
                   th:text=${pageNumber}
                   th:class="${pageNumber==portfolios.number + 1} ? active"></a>
                <a th:if="${userId != null}" th:href="@{/homepage(userId=${userId}, pfPage=${pageNumber}, stockPage=${stockCurrentPage})}"
                   th:text=${pageNumber}
                   th:class="${pageNumber==portfolios.number + 1} ? active"></a>
            </div>
        </div>
    </div>
    <div class="box right">
        <div class="left" style="border:0px;">
            <table style="margin:auto; width:90%">
                <caption><b>Current Buy Order</b></caption>
                <thead>
                <tr>
                    <th> Ticker </th>
                    <th> Quantity </th>
                    <th> Price </th>
                    <th> Player </th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${buyOrderList.empty}">
                    <td colspan="4" style="text-align:center;"> No Buy Order </td>
                </tr>
                <tr th:each="order : ${buyOrderList}">
                    <td><span th:text="${order.ticker}"> </span></td>
                    <td><span th:text="${order.quantity}"> </span></td>
                    <td><span th:text="${order.price}"> </span></td>
                    <td><span th:text="${order.playerId}"> </span></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="right" style="border:0px;">
            <table style="margin:auto; width:90%">
                <caption><b>Current Sell Order</b></caption>
                <thead>
                <tr>
                    <th> Ticker </th>
                    <th> Quantity </th>
                    <th> Price </th>
                    <th> Player </th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${sellOrderList.empty}">
                    <td colspan="4" style="text-align:center;"> No Sell Order </td>
                </tr>
                <tr th:each="order : ${sellOrderList}">
                    <td><span th:text="${order.ticker}"> </span></td>
                    <td><span th:text="${order.quantity}"> </span></td>
                    <td><span th:text="${order.price}"> </span></td>
                    <td><span th:text="${order.playerId}"> </span></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
    </main>
    <footer>
        <p>Developer: Sangyoon Kim<br>
            Email : <a href="projectaxelrod@gmail.com">projectaxelrod@gmail.com</a><br>
            Github : <a href="sangyun004@github.com">sangyun004@github.com</a></p>
    </footer>
</section>

<script th:inline="javascript">
    let userId = [[${userId}]];

    function fetchStockSearch(pageNum) {
        let inputVal = document.getElementById("stockKeyword").value;

        fetch('/searchStock?keyword=' + encodeURIComponent(inputVal) + '&pageNum=' + pageNum)
            .then(response => response.json())
            .then(data => {
                let stockTable = document.getElementById("stockTableBody");
                stockTable.innerHTML = "";
                let stockPage = data.stockPage;
                let pageNumbers = data.pageNumbers;
                let currentPage = data.currentPage;

                stockPage.forEach((stock, index) => {
                    let row = document.createElement("tr");
                    row.innerHTML = `
                    <td><a href="/homepage/stock?ticker=${stock.ticker}&userId=${userId}"><span>${stock.ticker}</span></a></td>
                    <td><span>${stock.price}</span></td>
                    `;
                    stockTable.appendChild(row);
                });

                let pagination = document.getElementById("stockPagination");
                pagination.innerHTML = "";

                pageNumbers.forEach((pageNum, index) => {
                    let row = document.createElement("a");
                    row.innerText = pageNum;
                    row.href = "#";
                    row.addEventListener("click", function(event) {
                        fetchStockSearch(pageNum);
                    });
                    console.log(pageNum, currentPage+1);
                    if (pageNum == currentPage) {
                        row.className = "active";
                    }
                    pagination.appendChild(row);
                });
            })
            .catch(error => console.error("Error:", error));
    }
</script>

</body>
</html>